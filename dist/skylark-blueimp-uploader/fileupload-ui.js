/**
 * skylark-blueimp-uploader - The skylark file uploader
 * @author Hudaokeji, Inc.
 * @version v0.0.1
 * @link https://github.com/skylark-integration/skylark-blueimp-uploader/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-utils-dom/eventer","skylark-jquery","./tmpl","./fileupload"],function(e,t,i,n,r){"use strict";return i.widget("blueimp.fileuploadui",{processActions:{},_processFile:function(e,t){var n=i.skylark.langx,r=this,o=n.map(e.processQueue,function(e){return function(t){return r.processActions[e.action].call(r,t,e)}});return n.async.waterful(o,[e],r)},_transformProcessQueue:function(e){var t=[];i.each(e.processQueue,function(){var n={},r=this.action,o=!0===this.prefix?r:this.prefix;i.each(this,function(t,r){"string"===i.type(r)&&"@"===r.charAt(0)?n[t]=e[r.slice(1)||(o?o+t.charAt(0).toUpperCase()+t.slice(1):t)]:n[t]=r}),t.push(n)}),e.processQueue=t},processing:function(){return this._processing},process:function(e){var t=this,n=i.extend({},this.options,e);return n.processQueue&&n.processQueue.length&&(this._transformProcessQueue(n),0===this._processing&&this._trigger("processstart"),i.each(e.files,function(r){var o=r?i.extend({},n):n,s=function(){return e.errorThrown?i.Deferred().rejectWith(t,[e]).promise():t._processFile(o,e)};o.index=r,t._processing+=1,t._processingQueue=t._processingQueue.pipe(s,s).always(function(){t._processing-=1,0===t._processing&&t._trigger("processstop")})})),this._processingQueue},options:{processQueue:[],autoUpload:!1,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:void 0,prependFiles:!1,dataType:"json",getNumberOfFiles:function(){return this.filesContainer.children().not(".processing").length},getFilesFromResponse:function(e){return e.result&&i.isArray(e.result.files)?e.result.files:[]},add:function(e,t){var n=i(this),r=n.data("blueimp-fileuploadui")||n.data("fileupload"),o=r.options;t.context=r._renderUpload(t.files).data("data",t).addClass("processing"),o.filesContainer[o.prependFiles?"prepend":"append"](t.context),r._forceReflow(t.context),r._transition(t.context),n.fileuploadui("process",t).always(function(){t.context.each(function(e){i(this).find(".size").text(r._formatFileSize(t.files[e].size))}).removeClass("processing"),r._renderPreviews(t)}).done(function(){t.context.find(".start").prop("disabled",!1),!1!==r._trigger("added",null,t)&&(o.autoUpload||t.autoUpload)&&!1!==t.autoUpload&&t.submit()}).fail(function(){t.files.error&&t.context.each(function(e){var n=t.files[e].error;n&&i(this).find(".error").text(n)})})},send:function(e,t){if(e.isDefaultPrevented())return!1;var n=i(this).data("blueimp-fileuploadui")||i(this).data("fileupload");return t.context&&t.dataType&&"iframe"===t.dataType.substr(0,6)&&t.context.find(".progress").addClass(!i.support.transition&&"progress-animated").attr("aria-valuenow",100).children().first().css("width","100%"),n._trigger("sent",null,t)},done:function(e,t){if(e.isDefaultPrevented())return!1;var n,r,o=i(this).data("blueimp-fileuploadui")||i(this).data("fileupload"),s=(t.getFilesFromResponse||o.options.getFilesFromResponse)(t);t.context?t.context.each(function(e){var a=s[e]||{error:"Empty file upload result"};r=o._addFinishedDeferreds(),o._transition(i(this)).done(function(){var e=i(this);n=o._renderDownload([a]).replaceAll(e),o._forceReflow(n),o._transition(n).done(function(){t.context=i(this),o._trigger("completed",null,t),o._trigger("finished",null,t),r.resolve()})})}):(n=o._renderDownload(s)[o.options.prependFiles?"prependTo":"appendTo"](o.options.filesContainer),o._forceReflow(n),r=o._addFinishedDeferreds(),o._transition(n).done(function(){t.context=i(this),o._trigger("completed",null,t),o._trigger("finished",null,t),r.resolve()}))},fail:function(e,t){if(e.isDefaultPrevented())return!1;var n,r,o=i(this).data("blueimp-fileuploadui")||i(this).data("fileupload");t.context?t.context.each(function(e){if("abort"!==t.errorThrown){var s=t.files[e];s.error=s.error||t.errorThrown||!0,r=o._addFinishedDeferreds(),o._transition(i(this)).done(function(){var e=i(this);n=o._renderDownload([s]).replaceAll(e),o._forceReflow(n),o._transition(n).done(function(){t.context=i(this),o._trigger("failed",null,t),o._trigger("finished",null,t),r.resolve()})})}else r=o._addFinishedDeferreds(),o._transition(i(this)).done(function(){i(this).remove(),o._trigger("failed",null,t),o._trigger("finished",null,t),r.resolve()})}):"abort"!==t.errorThrown?(t.context=o._renderUpload(t.files)[o.options.prependFiles?"prependTo":"appendTo"](o.options.filesContainer).data("data",t),o._forceReflow(t.context),r=o._addFinishedDeferreds(),o._transition(t.context).done(function(){t.context=i(this),o._trigger("failed",null,t),o._trigger("finished",null,t),r.resolve()})):(o._trigger("failed",null,t),o._trigger("finished",null,t),o._addFinishedDeferreds().resolve())},progress:function(e,t){if(e.isDefaultPrevented())return!1;var n=Math.floor(t.loaded/t.total*100);t.context&&t.context.each(function(){i(this).find(".progress").attr("aria-valuenow",n).children().first().css("width",n+"%")})},progressall:function(e,t){var n=i(this),r=Math.floor(t.loaded/t.total*100),o=n.find(".fileupload-progress"),s=o.find(".progress-extended");s.length&&s.html((n.data("blueimp-fileuploadui")||n.data("fileupload"))._renderExtendedProgress(t)),o.find(".progress").attr("aria-valuenow",r).children().first().css("width",r+"%")},start:function(e){if(e.isDefaultPrevented())return!1;var t=i(this).data("blueimp-fileuploadui")||i(this).data("fileupload");t._resetFinishedDeferreds(),t._transition(i(this).find(".fileupload-progress")).done(function(){t._trigger("started",null)})},stop:function(e){if(e.isDefaultPrevented())return!1;var t=i(this).data("blueimp-fileuploadui")||i(this).data("fileupload"),n=t._addFinishedDeferreds();i.when.apply(i,t._getFinishedDeferreds()).done(function(){t._trigger("stopped",null)}),t._transition(i(this).find(".fileupload-progress")).done(function(){i(this).find(".progress").attr("aria-valuenow","0").children().first().css("width","0%"),i(this).find(".progress-extended").html("&nbsp;"),n.resolve()})},processstart:function(e){if(e.isDefaultPrevented())return!1;i(this).addClass("fileupload-processing")},processstop:function(e){if(e.isDefaultPrevented())return!1;i(this).removeClass("fileupload-processing")},destroy:function(e,t){var n=i(this).data("blueimp-fileuploadui")||i(this).data("fileupload"),r=function(){n._transition(t.context).done(function(){i(this).remove(),n._trigger("destroyed",null,t)})};t.url?(t.dataType=t.dataType||n.options.dataType,i.ajax(t).done(r).fail(function(){n._trigger("destroyfailed",null,t)})):r()}},_resetFinishedDeferreds:function(){this._finishedUploads=[]},_addFinishedDeferreds:function(e){return e||(e=i.Deferred()),this._finishedUploads.push(e),e},_getFinishedDeferreds:function(){return this._finishedUploads},_enableDragToDesktop:function(){var e=i(this),t=e.prop("href"),n=e.prop("download"),r="application/octet-stream";e.bind("dragstart",function(e){try{e.originalEvent.dataTransfer.setData("DownloadURL",[r,n,t].join(":"))}catch(e){}})},_formatFileSize:function(e){return"number"!=typeof e?"":e>=1e9?(e/1e9).toFixed(2)+" GB":e>=1e6?(e/1e6).toFixed(2)+" MB":(e/1e3).toFixed(2)+" KB"},_formatBitrate:function(e){return"number"!=typeof e?"":e>=1e9?(e/1e9).toFixed(2)+" Gbit/s":e>=1e6?(e/1e6).toFixed(2)+" Mbit/s":e>=1e3?(e/1e3).toFixed(2)+" kbit/s":e.toFixed(2)+" bit/s"},_formatTime:function(e){var t=new Date(1e3*e),i=Math.floor(e/86400);return(i=i?i+"d ":"")+("0"+t.getUTCHours()).slice(-2)+":"+("0"+t.getUTCMinutes()).slice(-2)+":"+("0"+t.getUTCSeconds()).slice(-2)},_formatPercentage:function(e){return(100*e).toFixed(2)+" %"},_renderExtendedProgress:function(e){return this._formatBitrate(e.bitrate)+" | "+this._formatTime(8*(e.total-e.loaded)/e.bitrate)+" | "+this._formatPercentage(e.loaded/e.total)+" | "+this._formatFileSize(e.loaded)+" / "+this._formatFileSize(e.total)},_renderTemplate:function(e,t){if(!e)return i();var n=e({files:t,formatFileSize:this._formatFileSize,options:this.options});return n instanceof i?n:i(this.options.templatesContainer).html(n).children()},_renderPreviews:function(e){e.context.find(".preview").each(function(t,n){i(n).append(e.files[t].preview)})},_renderUpload:function(e){return this._renderTemplate(this.options.uploadTemplate,e)},_renderDownload:function(e){return this._renderTemplate(this.options.downloadTemplate,e).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(e){e.preventDefault();var t=i(e.currentTarget),n=t.closest(".template-upload").data("data");t.prop("disabled",!0),n&&n.submit&&n.submit()},_cancelHandler:function(e){e.preventDefault();var t=i(e.currentTarget).closest(".template-upload,.template-download"),n=t.data("data")||{};n.context=n.context||t,n.abort?n.abort():(n.errorThrown="abort",this._trigger("fail",null,n))},_deleteHandler:function(e){e.preventDefault();var t=i(e.currentTarget);this._trigger("destroy",null,i.extend({context:t.closest(".template-download"),type:"DELETE"},t.data()))},_forceReflow:function(e){return i.support.transition&&e.length&&e[0].offsetWidth},_transition:function(e){var t=i.Deferred();return i.support.transition&&e.hasClass("fade")&&e.is(":visible")?e.bind(i.support.transition.end,function(n){n.target===e[0]&&(e.unbind(i.support.transition.end),t.resolveWith(e))}).toggleClass("in"):(e.toggleClass("in"),t.resolveWith(e)),t},_initButtonBarEventHandlers:function(){var e=this.element.find(".fileupload-buttonbar"),t=this.options.filesContainer;this._on(e.find(".start"),{click:function(e){e.preventDefault(),t.find(".start").click()}}),this._on(e.find(".cancel"),{click:function(e){e.preventDefault(),t.find(".cancel").click()}}),this._on(e.find(".delete"),{click:function(i){i.preventDefault(),t.find(".toggle:checked").closest(".template-download").find(".delete").click(),e.find(".toggle").prop("checked",!1)}}),this._on(e.find(".toggle"),{change:function(e){t.find(".toggle").prop("checked",i(e.currentTarget).is(":checked"))}})},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar").find(".start, .cancel, .delete"),"click"),this._off(this.element.find(".fileupload-buttonbar .toggle"),"change.")},_initEventHandlers:function(){this._on(this.options.filesContainer,{"click .start":this._startHandler,"click .cancel":this._cancelHandler,"click .delete":this._deleteHandler}),this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers(),this._off(this.options.filesContainer,"click"),this._super()},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){var e=this.options;e.templatesContainer=this.document[0].createElement(e.filesContainer.prop("nodeName")),n&&(e.uploadTemplateId&&(e.uploadTemplate=n(e.uploadTemplateId)),e.downloadTemplateId&&(e.downloadTemplate=n(e.downloadTemplateId)))},_initFilesContainer:function(){var e=this.options;void 0===e.filesContainer?e.filesContainer=this.element.find(".files"):e.filesContainer instanceof i||(e.filesContainer=i(e.filesContainer))},_initSpecialOptions:function(){this._initFilesContainer(),this._initTemplates()},_create:function(){this._super(),this._processing=0,this._processingQueue=i.Deferred().resolveWith(this).promise(),this._initSpecialOptions(),this._initEventHandlers(),this._uploader=r(this.element,this.options),this._resetFinishedDeferreds(),i.support.fileInput||this._disableFileInputButton()},enable:function(){var e=!1;this.options.disabled&&(e=!0),this._super(),e&&(this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton())},disable:function(){this.options.disabled||(this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton()),this._super()}}),i});
//# sourceMappingURL=sourcemaps/fileupload-ui.js.map
